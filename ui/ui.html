<html>
<head>
<title>Zelij Tiling!</title>

<script type="text/javascript">

var canvas;
var ctx;

var callhome;

var polygons = new Array();
var numpolys = 0;

var redrawTimer;

function Polygon(pts,num) {
	this.pts = pts
	this.num = num

	this.Draw = function (ctx) {
		if( this.num < 2 ) {
			return;
		}

		ctx.beginPath();
		ctx.moveTo(this.pts[0].x,this.pts[0].y);

		for(var i = 1; i < this.num; i++) {
			ctx.lineTo(this.pts[i].x,this.pts[i].y);
		}

		if( this.num >= 3 ) {
			ctx.closePath();
		}

		ctx.stroke();
	}

	this.toString = function() {
		str = this.pts[0].toString()

		for(var i = 1; i < this.num; i++) {
			str = str+":"+this.pts[i].toString()
		}
		return str
	}

	this.AddPoint = function (pt) {
		this.pts[this.num] = pt
		this.num++
	}
}
		

function Point(x,x2,y,y2) {
	this.x = x;
	this.x2 = x2;
	this.y = y;
	this.y2 = y2;

	this.toString = function () {
		return (this.x+","+this.x2+","+this.y+","+this.y2);
	}
} 

function beginDrawing() {
	numpolys = 0;
	nextPolygon()
	
	clearCanvas();

	document.getElementById("render").style.display = 'none';
	document.getElementById("preview").style.display = 'block';
}

function drawPolys() {
	for(var i = 0; i < numpolys; i++) {
		polygons[i].Draw(ctx)
	}
}

function mouseClickCanvasCoordinates(event) {
	var x = event.clientX + document.body.scrollLeft +
            document.documentElement.scrollLeft - canvas.offsetLeft;
	var y = event.clientY + document.body.scrollTop +
            document.documentElement.scrollTop - canvas.offsetTop;
	return new Point(x,0,y,0);
}

function pointClick(event) {
	polygons[numpolys-1].AddPoint(mouseClickCanvasCoordinates(event));
	clearCanvas();
	drawPolys();
}

function nextPolygon() {
	polygons[numpolys] = new Polygon(new Array(),0)
	numpolys++;
}

function clearCanvas() {
	ctx.clearRect(0,0,canvas.width,canvas.height);
}	


function renderTiles() {

	var srcstr = "svg?polys="+polygons[0].toString();
	
	for(var i = 1; i < numpolys; i++) {
		srcstr += "&polys="+polygons[i].toString();
	}

	document.getElementById("render").src = srcstr;
	document.getElementById("preview").style.display = 'none';
	document.getElementById("render").style.display = 'block';
}

function startTiling() {
	callhome.open("GET","http://localhost:8080/start",true)
	callhome.send()
	alert("Tiling Started")
}

function nextTiling() {
	var currentTime = new Date()
	var srcstr = "tiles?foo="+currentTime.getTime()

	document.getElementById("render").src = srcstr;
	document.getElementById("preview").style.display = 'none';
	document.getElementById("render").style.display = 'block';
	redrawTimer = setTimeout("nextTiling()",1000)
}

function init() {
	canvas = document.getElementById("preview");
	ctx = canvas.getContext('2d');

	canvas.addEventListener("click",pointClick,false);
	callhome = new XMLHttpRequest()
}

</script>
</head>

<body onload="init()">
<div id="menu">
<a href="#foo"  onclick="beginDrawing()" >Start Drawing</a>
<a href="#foo"  onclick="startTiling()" >Start Tiling</a>
<a href="#foo"  onclick="nextTiling()" >Next Tiling</a>
<a href="#foo"  onclick="nextPolygon()" >New Polygon</a>
<a href="#foo"  onclick="renderTiles()" >Render</a>
</div>
<canvas id="preview" width=288 height=288 style="border: 1px solid #000000;">
Oh no something is wrong
</canvas>
<iframe src="svg" id="render" width=600 height=600 style="display: none;"/>
</body>
</html>
